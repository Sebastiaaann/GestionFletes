{% extends "partials/gestion_layout.html" %}

{% load widget_tweaks %}

{% block tittle%}Gestion de Recorridos{% endblock %}

{% block gestion_header %}
        <div class="d-flex align-items-start mb-3">
            <div>
                <h2 class="mb-0">Gestion de Recorridos</h2>
            </div>
            <div class="ms-auto">
                <button form="recorridosForm" type="submit" class="btn btn-primary">Guardar</button>
            </div>
        </div>
{% endblock %}

{% block gestion_body %}
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-dismissible alert-success"><strong class="text-dark"> {{message}}</strong></div>
            {% endfor %}
        {% endif %}

        {% if costo_bencina %}
            <div class="alert alert-info">
                <strong>Costo estimado de bencina para este recorrido: ${{ costo_bencina|floatformat:0 }}</strong>
            </div>
        {% endif %}

        <form id="recorridosForm" action="{% url 'registrarRecorridos' %}" method="post">
            {% csrf_token %}
            <div class="mb-3">{{ form.conductor.label_tag }}{% render_field form.conductor class="form-control" %}</div>
            <div class="mb-3">{{ form.vehiculo.label_tag }}{% render_field form.vehiculo class="form-control" %}</div>
            <div class="mb-3">{{ form.fecha.label_tag }}{% render_field form.fecha class="form-control" type="date" %}</div>
            <div class="mb-3">{{ form.direccionOrigen.label_tag }}{% render_field form.direccionOrigen class="form-control" %}</div>
            <div class="mb-3">{{ form.direccionDestino.label_tag }}{% render_field form.direccionDestino class="form-control" %}</div>
            <div class="mb-3">{{ form.carga.label_tag }}{% render_field form.carga class="form-control" %}</div>
            <div class="mb-3">{{ form.detalle.label_tag }}{% render_field form.detalle class="form-control" %}</div>
            <div class="mb-3">{{ form.distancia_km.label_tag }}{% render_field form.distancia_km class="form-control" %}</div>
            <div class="mb-3">{{ form.gps_data.label_tag }}{% render_field form.gps_data class="form-control" placeholder="JSON, GPX, KML, etc." %}</div>
        </form>
    {% endblock %}

    {% block gestion_after %}
        <h5>Listado De Recorridos</h5>
        <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
        <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
        <div class="table responsive py-2">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>conductor</th>
                        <th>vehiculo</th>
                        <th>Fecha</th>
                        <th>direccionOrigen</th>
                        <th>direccionDestino</th>
                        <th>carga</th>
                        <th>detalle</th>
                        <th>distancia (km)</th>
                        <th>GPS Data</th>
                        <th>Ruta en Mapa</th>
                        <th colspan="2">Opciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for recorrido in recorridos %}
                        <tr>
                            <td>{{recorrido.recorridoID}}</td>
                            <td>{{recorrido.conductor.nombre}}</td>
                            <td>{{recorrido.vehiculo.patente}}</td>
                            <td>{{recorrido.fecha}}</td>
                            <td>{{recorrido.direccionOrigen}}</td>
                            <td>{{recorrido.direccionDestino}}</td>
                            <td>{{recorrido.carga}}</td>
                            <td>{{recorrido.detalle}}</td>
                            <td>{{recorrido.distancia_km}}</td>
                            <td>{{recorrido.gps_data}}</td>
                            <td>
                                {% if recorrido.gps_data %}
                                    <div id="map{{recorrido.recorridoID}}" style="height:200px;width:300px;"></div>
                                    <script>
                                        try {
                                            var gpsData = JSON.parse('{{ recorrido.gps_data|escapejs }}');
                                            if (Array.isArray(gpsData) && gpsData.length > 0) {
                                                var map = L.map('map{{recorrido.recorridoID}}').setView([gpsData[0][0], gpsData[0][1]], 13);
                                                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                                                    maxZoom: 18,
                                                    attribution: 'Â© OpenStreetMap'
                                                }).addTo(map);
                                                var latlngs = gpsData.map(function(coord) { return [coord[0], coord[1]]; });
                                                var polyline = L.polyline(latlngs, {color: 'blue'}).addTo(map);
                                                map.fitBounds(polyline.getBounds());

                                                // Marcador inicio
                                                var startMarker = L.marker(latlngs[0]).addTo(map);
                                                startMarker.bindPopup('Inicio del recorrido').openPopup();

                                                // Marcador fin
                                                var endMarker = L.marker(latlngs[latlngs.length-1]).addTo(map);
                                                endMarker.bindPopup('Fin del recorrido');

                                                // Popup al hacer clic en la ruta
                                                polyline.on('click', function(e) {
                                                    L.popup()
                                                     .setLatLng(e.latlng)
                                                     .setContent('Ruta del conductor')
                                                     .openOn(map);
                                                });
                                            }
                                        } catch (e) {
                                            // Invalid GPS data
                                        }
                                    </script>
                                {% else %}
                                    <span class="text-muted">Sin datos</span>
                                {% endif %}
                            </td>
                            <td>
                                <a href ="{%url 'editarRecorridos' recorrido.recorridoID %}" class = "btn btn-sm btn-outline-primary" >Editar </a>
                            </td>
                            <td>
                                <a href ="{%url 'eliminarRecorridos' recorrido.recorridoID %}" class = "btn btn-sm btn-outline-danger btnEliminacion" >Eliminar </a>
                            </td>
                            <td>
                                <a href="{% url 'detalleRecorrido' recorrido.recorridoID %}" class="btn btn-sm btn-info">Ver Detalle</a>
                            </td>
                            <td>
                                <a href="{% url 'detalleGastoBencina' recorrido.recorridoID %}" class="btn btn-sm btn-warning">Gasto Bencina</a>
                            </td>
                        </tr>
                    {% empty %}
                        <tr><td colspan="14">No recorridos registrados.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% endblock %}

    <ul class="nav flex-column">
    <li class="nav-item mb-2"><a class="nav-link" href="{% url 'home' %}">Home</a></li>
    </ul>